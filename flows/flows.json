[{"id":"87a7ca34e2267354","type":"inject","z":"5e17eab6afbdcf45","name":"","props":[{"p":"payload"},{"p":"topic","v":"{   \"Temperatura\": 30.9,   \"Umidade\": 48.0,   \"CO2\": 261.0,   \"Solo\": -300.0,   \"Orvalho\": 160.68 }","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":140,"y":820,"wires":[["d66cd58fe22ba8ab"]]},{"id":"4e14b33a2efecc07","type":"debug","z":"5e17eab6afbdcf45","name":"debug 1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":920,"y":20,"wires":[]},{"id":"83e995c3d830c665","type":"mqtt in","z":"5e17eab6afbdcf45","name":"662267b4d75448ff9ab5c5bcb043bd1f","topic":"google-sheets-data","qos":"0","datatype":"auto-detect","broker":"9d0c82ad1f277388","nl":false,"rap":true,"rh":0,"inputs":0,"x":230,"y":20,"wires":[["4e14b33a2efecc07","b925c1307aafd34a","3368511745987b35","2796932c38b9514f","fd70e3f396819dee","cdc86d5956828e2a","57895ebe287518d0","lum_change","rain_change","calc_prob_from_payload"]]},{"id":"d66cd58fe22ba8ab","type":"mqtt out","z":"5e17eab6afbdcf45","name":"662267b4d75448ff9ab5c5bcb043bd1f","topic":"google-sheets-data","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"9d0c82ad1f277388","x":870,"y":820,"wires":[]},{"id":"3534936871e0d66e","type":"ui_gauge","z":"5e17eab6afbdcf45","name":"","group":"00c7969fe6a51bf6","order":1,"width":0,"height":0,"gtype":"gage","title":"Temp","label":"ºC","format":"{{payload}}","min":"-5","max":"55","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":990,"y":100,"wires":[]},{"id":"d84ac9119ffcfbb6","type":"ui_gauge","z":"5e17eab6afbdcf45","name":"","group":"00c7969fe6a51bf6","order":2,"width":0,"height":0,"gtype":"gage","title":"Umid","label":"%","format":"{{payload}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":990,"y":140,"wires":[]},{"id":"b925c1307aafd34a","type":"change","z":"5e17eab6afbdcf45","name":"definir msg.payload.Temp","rules":[{"t":"set","p":"payload","pt":"msg","to":"msg.payload.Temperatura","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":100,"wires":[["3534936871e0d66e","5318649c6bd370da"]]},{"id":"3368511745987b35","type":"change","z":"5e17eab6afbdcf45","name":"definir msg.payload.Umid","rules":[{"t":"set","p":"payload","pt":"msg","to":"msg.payload.Umidade","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":140,"wires":[["d84ac9119ffcfbb6","5318649c6bd370da","ccf401d1eedab854"]]},{"id":"5318649c6bd370da","type":"debug","z":"5e17eab6afbdcf45","name":"debug 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":940,"y":60,"wires":[]},{"id":"2796932c38b9514f","type":"change","z":"5e17eab6afbdcf45","name":"definir msg.payload.CO2","rules":[{"t":"set","p":"payload","pt":"msg","to":"msg.payload.CO2","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":180,"wires":[["5318649c6bd370da","co2_text","bc239793d7969d50"]]},{"id":"fd70e3f396819dee","type":"change","z":"5e17eab6afbdcf45","name":"definir msg.payload.Solo","rules":[{"t":"set","p":"payload","pt":"msg","to":"msg.payload.Solo","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":220,"wires":[["5318649c6bd370da","ee04cf1ffcd48d8a","c75518c4adab8d55"]]},{"id":"cdc86d5956828e2a","type":"change","z":"5e17eab6afbdcf45","name":"definir msg.payload.Orvalho","rules":[{"t":"set","p":"payload","pt":"msg","to":"msg.payload.Orvalho","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":260,"wires":[["5318649c6bd370da","08fab7ac87bb7b32"]]},{"id":"ee04cf1ffcd48d8a","type":"ui_gauge","z":"5e17eab6afbdcf45","name":"","group":"00c7969fe6a51bf6","order":3,"width":0,"height":0,"gtype":"gage","title":"Umid. Solo","label":"%","format":"{{payload}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":1010,"y":220,"wires":[]},{"id":"08fab7ac87bb7b32","type":"ui_gauge","z":"5e17eab6afbdcf45","name":"","group":"f736f70ae8c61a61","order":5,"width":0,"height":0,"gtype":"gage","title":"P.t. Orv.","label":"ºC","format":"{{payload}}","min":"-5","max":"55","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","diff":false,"className":"","x":1000,"y":260,"wires":[]},{"id":"b5696f2a2e8d16e7","type":"debug","z":"5e17eab6afbdcf45","name":"debug 3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1000,"y":760,"wires":[]},{"id":"0845754d25044145","type":"debug","z":"5e17eab6afbdcf45","name":"debug 4","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":720,"y":660,"wires":[]},{"id":"308ef86ebc1bfcfe","type":"http request","z":"5e17eab6afbdcf45","name":"","method":"POST","ret":"txt","paytoqs":"ignore","url":"https://script.google.com/macros/s/AKfycbyM348FjuVLAGaz2VBjCJMf-L-OJL8RVSc_ln9oIOHvpwBP-jkN4s_1E1iWJZcwIYni7g/exec","tls":"","persist":false,"proxy":"","insecureHTTPParser":true,"authType":"","senderr":false,"headers":[],"x":780,"y":760,"wires":[["b5696f2a2e8d16e7"]]},{"id":"57895ebe287518d0","type":"function","z":"5e17eab6afbdcf45","name":"function_requ","func":"msg.url = \"https://script.google.com/macros/s/AKfycbyM348FjuVLAGaz2VBjCJMf-L-OJL8RVSc_ln9oIOHvpwBP-jkN4s_1E1iWJZcwIYni7g/exec\";  // Sua URL do Google Apps Script\n\nvar dados = msg.payload;  // Dados recebidos (como JSON)\n\nmsg.payload = {\n  Temperatura: dados.Temperatura,\n  Umidade: dados.Umidade,\n  CO2: dados.CO2,\n  Solo: dados.Solo,\n  Orvalho: dados.Orvalho,\n  Luminosidade: dados.Luminosidade,\n  Chuva: dados.Chuva\n};\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":540,"y":760,"wires":[["0845754d25044145","308ef86ebc1bfcfe"]]},{"id":"2c3ab6bfeb7e6049","type":"ui_button","z":"5e17eab6afbdcf45","d":true,"name":"","group":"e30071bd08154d5d","order":10,"width":0,"height":0,"passthru":false,"label":"Refresh","tooltip":"","color":"","bgcolor":"","className":"","icon":"","payload":"send_data","payloadType":"str","topic":"topic","topicType":"msg","x":100,"y":260,"wires":[["fbbb3ecd0646880d"]]},{"id":"fbbb3ecd0646880d","type":"mqtt out","z":"5e17eab6afbdcf45","name":"662267b4d75448ff9ab5c5bcb043bd1f","topic":"est-meteo/command","qos":"0","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"9d0c82ad1f277388","x":230,"y":120,"wires":[]},{"id":"co2_text","type":"ui_text","z":"5e17eab6afbdcf45","group":"00c7969fe6a51bf6","order":4,"width":0,"height":0,"name":"CO2","label":"CO₂","format":"{{msg.payload}} ppm","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":990,"y":180,"wires":[]},{"id":"vento_http","type":"http request","z":"5e17eab6afbdcf45","name":"Open-Meteo API","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.open-meteo.com/v1/forecast?latitude=-29.7&longitude=-53.7&current=precipitation,wind_speed_10m&daily=precipitation_sum&timezone=auto","tls":"","persist":false,"proxy":"","authType":"","x":320,"y":1400,"wires":[["formatar_clima"]]},{"id":"inject_clima","type":"inject","z":"5e17eab6afbdcf45","name":"Atualiza Clima","props":[],"repeat":"1800","crontab":"","once":true,"onceDelay":"0.1","topic":"","x":110,"y":1400,"wires":[["vento_http"]]},{"id":"formatar_clima","type":"function","z":"5e17eab6afbdcf45","name":"Formatar Clima","func":"// Dados atuais\nlet current = msg.payload.current;\nlet daily = msg.payload.daily;\n\nmsg.vento = current.wind_speed_10m;\nmsg.chuva = current.precipitation;\nmsg.prev_chuva = daily.precipitation_sum[0];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":550,"y":1400,"wires":[["vento_text","chuva_text","prev_chuva_text","logica_status"]]},{"id":"vento_text","type":"ui_text","z":"5e17eab6afbdcf45","group":"e30071bd08154d5d","order":7,"width":0,"height":0,"name":"Vento Atual","label":"Vento","format":"{{msg.vento}} km/h","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":810,"y":1360,"wires":[]},{"id":"chuva_text","type":"ui_text","z":"5e17eab6afbdcf45","group":"e30071bd08154d5d","order":4,"width":0,"height":0,"name":"Chuva Atual","label":"Chuva","format":"{{msg.chuva}} mm/h","layout":"row-spread","x":810,"y":1400,"wires":[]},{"id":"prev_chuva_text","type":"ui_text","z":"5e17eab6afbdcf45","group":"e30071bd08154d5d","order":1,"width":0,"height":0,"name":"Previsão Chuva Dia","label":"Previsão Hoje","format":"{{msg.prev_chuva}} mm","layout":"row-spread","x":820,"y":1440,"wires":[]},{"id":"status_geral","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":11,"width":0,"height":0,"name":"Pulverização","label":"Pulverização","format":"{{msg.status_pulv_text}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":860,"y":1540,"wires":[]},{"id":"alerta_clima","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":10,"width":0,"height":0,"name":"adubação ","label":"Adubação","format":"{{msg.alerta_adub_text}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":840,"y":1620,"wires":[]},{"id":"logica_status","type":"function","z":"5e17eab6afbdcf45","name":"Lógica Status/Alerta","func":"let vento = msg.vento || 0;\nlet chuva = msg.prev_chuva || 0;\n\n\nlet status_pulv = \"OK\";\nlet status_adub = \"OK\";\nlet cor = \"green\";\n\n\nif (vento >= 10 || chuva > 1) {\n    status_pulv = \"N Indicado\";\n   \n    \n} \nif (chuva == 0) {\n status_adub = \"Indicado\";\n}\n\n\nif (vento <= 10 && chuva <= 1&& chuva != 0) {\n    status_adub = \"Atenção\";\n    status_pulv = \"Atenção\";\n    \n}\n\n\n\n\n\nif (vento < 10 && chuva == 0) {\n    status_adub = \"Indicado\";\n    status_pulv = \"Indicado\";\n    \n}\n\n\nmsg.status_pulv_text = `<div style='color:${cor};font-weight:bold;'>${status_pulv}</div>`;\nmsg.alerta_pulv_text = `<div style='color:${cor};font-weight:bold;'>${status_pulv}</div>`;\n\nmsg.status_adub_text = `<div style='color:${cor};font-weight:bold;'>${status_adub}</div>`;\nmsg.alerta_adub_text = `<div style='color:${cor};font-weight:bold;'>${status_adub}</div>`;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":580,"y":1560,"wires":[["status_geral","alerta_clima"]]},{"id":"21d979c63aa49dc7","type":"inject","z":"5e17eab6afbdcf45","name":"Set Área X OK","props":[{"p":"payload"}],"repeat":"20","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"OK","payloadType":"str","x":400,"y":1140,"wires":[["8941451a78913547"]]},{"id":"e74cda87b27ab231","type":"inject","z":"5e17eab6afbdcf45","name":"Set Área Y Atenção","props":[{"p":"payload"}],"repeat":"20","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"Atenção – Floração","payloadType":"str","x":420,"y":1080,"wires":[["e0596c7cca18f35e"]]},{"id":"c75518c4adab8d55","type":"function","z":"5e17eab6afbdcf45","name":"Lógica Status/Alerta","func":"let solo = msg.payload;\nlet cor = \"black\"\n\nlet status_solo = \"OK\";\nlet status_irrig = \"OK\";\n\nif (solo > 75) {\n    status_solo = \"Alta\";\n    status_irrig = \"N Indicado\";\n}\nelse if (solo > 40 && solo < 75) {\n    status_solo = \"Normal\";  \n    status_irrig = \"N Indicado\"; \n} \n if( solo < 40)  {\n    status_solo = \"Atenção\";\n    status_irrig = \"Indicado\";\n   \n}\n\nmsg.status_solo_text = `<div style='color:${cor};font-weight:bold;'>${status_solo}</div>`;\nmsg.status_irrig_text = `<div style='color:${cor};font-weight:bold;'>${status_irrig}</div>`;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":1000,"wires":[["90f6e8422a7ab4c5","56bb4e59697ef962"]]},{"id":"ccf401d1eedab854","type":"function","z":"5e17eab6afbdcf45","name":"Lógica Status/Alerta","func":"let ar = msg.payload; // Ajuste o campo conforme a chave real que contém a umidade do ar\nlet cor = \"black\";\n\n\nlet status_ar = \"OK\";\nlet status_umid = \"OK\";\n\nif (ar > 80) {\n    status_ar = \"Alta\";\n    cor = \"red\";\n    status_umid = \"Atenção\";\n    cor = \"red\";\n} else if (ar >= 40) {\n    status_ar = \"Normal\";\n    cor = \"green\";\n    status_umid = \"Ok\";\n    cor = \"green\";\n} else {\n    status_ar = \"Baixa\";\n    cor = \"orange\";\n    status_umid = \"Hidratação\";\n    cor = \"blue\";\n}\n\nmsg.status_ar_text = `<div style='color:${cor};font-weight:bold;'>${status_ar}</div>`;\nmsg.status_umid_text = `<div style='color:${cor};font-weight:bold;'>${status_umid}</div>`;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":900,"wires":[["5179cd16267baa6f","d3ea3423c1b2ed28"]]},{"id":"5179cd16267baa6f","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":8,"width":0,"height":0,"name":"Alerta ar","label":"Alerta Ar","format":"{{msg.status_umid_text}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":900,"y":960,"wires":[]},{"id":"lum_change","type":"change","z":"5e17eab6afbdcf45","name":"definir msg.payload.Luminosidade","rules":[{"t":"set","p":"payload","pt":"msg","to":"msg.payload.Luminosidade","tot":"msg"}],"x":580,"y":360,"wires":[["lum_gauge","lum_text"]]},{"id":"lum_gauge","type":"ui_gauge","z":"5e17eab6afbdcf45","name":"Gauge Luminosidade","group":"f736f70ae8c61a61","order":6,"width":0,"height":0,"gtype":"gage","title":"Luminosidade","label":"%","format":"{{payload}}","min":0,"max":"100","colors":["#ca3838","#e6e600","#00b500"],"seg1":"","seg2":"","diff":false,"className":"","x":950,"y":340,"wires":[]},{"id":"lum_text","type":"ui_text","z":"5e17eab6afbdcf45","group":"f736f70ae8c61a61","order":7,"width":0,"height":0,"name":"Texto Luminosidade","label":"Luminosidade","format":"{{msg.payload}} %","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":960,"y":380,"wires":[]},{"id":"rain_change","type":"change","z":"5e17eab6afbdcf45","name":"definir msg.payload.Chuva","rules":[{"t":"set","p":"payload","pt":"msg","to":"msg.payload.Chuva","tot":"msg"}],"x":580,"y":460,"wires":[["rain_gauge","rain_text"]]},{"id":"rain_gauge","type":"ui_gauge","z":"5e17eab6afbdcf45","name":"Gauge Chuva","group":"f736f70ae8c61a61","order":8,"width":0,"height":0,"gtype":"gage","title":"Chuva Real","label":"%","format":"{{payload}}","min":0,"max":"100","colors":["#ca3838","#e6e600","#00b500"],"seg1":"","seg2":"","diff":false,"className":"","x":950,"y":440,"wires":[]},{"id":"rain_text","type":"ui_text","z":"5e17eab6afbdcf45","group":"f736f70ae8c61a61","order":9,"width":0,"height":0,"name":"Texto Chuva","label":"Chuva Real","format":"{{msg.payload}} %","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":960,"y":480,"wires":[]},{"id":"0f243b38c64a81b6","type":"ui_chart","z":"5e17eab6afbdcf45","name":"Gráfico Temperatura","group":"e30071bd08154d5d","order":11,"width":0,"height":0,"label":"Temperatura (24h)","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"Aguardando dados...","dot":false,"ymin":"-5","ymax":"50","removeOlder":"24","removeOlderPoints":"1288","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#4c00ff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"outputs":1,"useDifferentColor":false,"className":"","x":960,"y":1780,"wires":[[]]},{"id":"c1a1fdd5b2a28c2a","type":"inject","z":"5e17eab6afbdcf45","name":"Atualizar a cada 5min","props":[],"repeat":"300","once":true,"onceDelay":0.1,"topic":"","x":140,"y":1780,"wires":[["a91ffb28d2874f5a"]]},{"id":"f38d0d47f2e9fbbe","type":"function","z":"5e17eab6afbdcf45","name":"Filtrar últimas 24h","func":"let now = new Date();\nlet cutoff = now.getTime() - 24*60*60*1000; // 24h atrás\n\nlet dados = msg.payload;\nlet filtrado = dados.filter(l => new Date(l.timestamp).getTime() >= cutoff);\n\nmsg.payload = [{\n    series: [\"Temperatura\"],\n    data: [filtrado.map(l => ({ x: new Date(l.timestamp), y: Number(l.Temperatura) }))],\n    labels: [\"\"]\n}];\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":1780,"wires":[["0f243b38c64a81b6"]]},{"id":"a91ffb28d2874f5a","type":"http request","z":"5e17eab6afbdcf45","name":"Buscar JSON da Planilha","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://script.google.com/macros/s/AKfycbyM348FjuVLAGaz2VBjCJMf-L-OJL8RVSc_ln9oIOHvpwBP-jkN4s_1E1iWJZcwIYni7g/exec","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"basic","senderr":false,"headers":[],"x":400,"y":1780,"wires":[["f38d0d47f2e9fbbe"]]},{"id":"1da970e4d4cbc3ea","type":"ui_chart","z":"5e17eab6afbdcf45","name":"Gráfico Umidade","group":"e30071bd08154d5d","order":12,"width":0,"height":0,"label":"Umidade (24h)","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"Aguardando dados...","dot":false,"ymin":"0","ymax":"100","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#002aff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"outputs":1,"useDifferentColor":false,"className":"","x":930,"y":1860,"wires":[[]]},{"id":"706c5fedbc627f5e","type":"inject","z":"5e17eab6afbdcf45","name":"Atualizar a cada 5min","props":[],"repeat":"300","once":true,"onceDelay":0.1,"topic":"","x":140,"y":1860,"wires":[["4cec08b3c414c219"]]},{"id":"800b67f31a8dc547","type":"function","z":"5e17eab6afbdcf45","name":"Filtrar últimas 24h","func":"let now = new Date();\nlet cutoff = now.getTime() - 24*60*60*1000; // 24h atrás\n\nlet dados = msg.payload;\nlet filtrado = dados.filter(l => new Date(l.timestamp).getTime() >= cutoff);\n\nmsg.payload = [{\n    series: [\"Umidade\"],\n    data: [filtrado.map(l => ({ x: new Date(l.timestamp), y: Number(l.Umidade) }))],\n    labels: [\"\"]\n}];\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":1860,"wires":[["1da970e4d4cbc3ea"]]},{"id":"4cec08b3c414c219","type":"http request","z":"5e17eab6afbdcf45","name":"Buscar JSON da Planilha","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://script.google.com/macros/s/AKfycbyM348FjuVLAGaz2VBjCJMf-L-OJL8RVSc_ln9oIOHvpwBP-jkN4s_1E1iWJZcwIYni7g/exec","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":380,"y":1860,"wires":[["800b67f31a8dc547"]]},{"id":"204815151705c1a0","type":"ui_chart","z":"5e17eab6afbdcf45","name":"Gráfico Solo","group":"e30071bd08154d5d","order":13,"width":0,"height":0,"label":"Umidade Solo (24h)","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"Aguardando dados...","dot":false,"ymin":"0","ymax":"100","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#00ff11","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"outputs":1,"useDifferentColor":false,"className":"","x":910,"y":1960,"wires":[[]]},{"id":"9c146c87d4a7b180","type":"inject","z":"5e17eab6afbdcf45","name":"Atualizar a cada 5min","props":[],"repeat":"300","once":true,"onceDelay":0.1,"topic":"","x":140,"y":1960,"wires":[["9460d28aa0d2c060"]]},{"id":"77f76e91551b0a5f","type":"function","z":"5e17eab6afbdcf45","name":"Filtrar últimas 24h","func":"let now = new Date();\nlet cutoff = now.getTime() - 24*60*60*1000; // 24h atrás\n\nlet dados = msg.payload;\nlet filtrado = dados.filter(l => new Date(l.timestamp).getTime() >= cutoff);\n\nmsg.payload = [{\n    series: [\"Solo\"],\n    data: [filtrado.map(l => ({ x: new Date(l.timestamp), y: Number(l.Solo) }))],\n    labels: [\"\"]\n}];\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":1960,"wires":[["204815151705c1a0"]]},{"id":"9460d28aa0d2c060","type":"http request","z":"5e17eab6afbdcf45","name":"Buscar JSON da Planilha","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://script.google.com/macros/s/AKfycbyM348FjuVLAGaz2VBjCJMf-L-OJL8RVSc_ln9oIOHvpwBP-jkN4s_1E1iWJZcwIYni7g/exec","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":380,"y":1960,"wires":[["77f76e91551b0a5f"]]},{"id":"selfping-inject","type":"inject","z":"5e17eab6afbdcf45","name":"Ping a cada 3 min","props":[],"repeat":"180","crontab":"","once":true,"onceDelay":0.1,"topic":"","x":130,"y":2380,"wires":[["selfping-http"]]},{"id":"selfping-http","type":"http request","z":"5e17eab6afbdcf45","name":"Ping Render","method":"GET","ret":"txt","paytoqs":"ignore","url":"https://est-met-render.onrender.com","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":350,"y":2380,"wires":[[]]},{"id":"co2_gsheet_inject","type":"inject","z":"5e17eab6afbdcf45","name":"atualizar gps","props":[],"repeat":"30","crontab":"","once":true,"onceDelay":1,"topic":"","x":200,"y":2560,"wires":[["830d62efe146b41f"]]},{"id":"8181620c3fb871ae","type":"inject","z":"5e17eab6afbdcf45","name":"Atualizar a cada 5min","props":[],"repeat":"300","once":true,"onceDelay":0.1,"topic":"","x":140,"y":2020,"wires":[["979c888177a251f4"]]},{"id":"979c888177a251f4","type":"http request","z":"5e17eab6afbdcf45","name":"Buscar JSON da Planilha","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://script.google.com/macros/s/AKfycbyM348FjuVLAGaz2VBjCJMf-L-OJL8RVSc_ln9oIOHvpwBP-jkN4s_1E1iWJZcwIYni7g/exec","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":380,"y":2020,"wires":[["6aa8d6423286291e"]]},{"id":"cb6fb8703bf504d0","type":"ui_chart","z":"5e17eab6afbdcf45","name":"CO2","group":"e30071bd08154d5d","order":13,"width":0,"height":0,"label":"CO2 (24h)","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"Aguardando dados...","dot":false,"ymin":"0","ymax":"1200","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#00ff11","#e6e93a","#d0481b","#000000","#000000","#000000","#000000","#000000","#000000"],"outputs":1,"useDifferentColor":false,"className":"","x":890,"y":2020,"wires":[[]]},{"id":"6aa8d6423286291e","type":"function","z":"5e17eab6afbdcf45","name":"Filtrar últimas 24h","func":"let now = new Date();\nlet cutoff = now.getTime() - 24*60*60*1000; // 24h atrás\n\nlet dados = msg.payload;\nlet filtrado = dados.filter(l => new Date(l.timestamp).getTime() >= cutoff);\n\nmsg.payload = [{\n    series: [\"CO2\"],\n    data: [filtrado.map(l => ({ x: new Date(l.timestamp), y: Number(l.CO2) }))],\n    labels: [\"\"]\n}];\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":2020,"wires":[["cb6fb8703bf504d0"]]},{"id":"bc239793d7969d50","type":"function","z":"5e17eab6afbdcf45","name":"Lógica Status/Alerta","func":"let CO2 = msg.payload; // Ajuste o campo conforme a chave real que contém a umidade do ar\nlet cor = \"black\";\n\n\nlet status_CO2 = \"OK\";\nlet alerta_CO2 = \"OK\";\n\nif (CO2 < 380) {\n    status_CO2 = \"Baixo\";\n    alerta_CO2 = \"Normal\"\n    cor = \"black\";\n}\nif (CO2 > 381 && CO2 < 750) {\n    status_CO2 = \"Alto\";\n    alerta_CO2 = \"Atenção\"\n    cor = \"black\";\n}\nif (CO2 > 751 ) {\n    status_CO2 = \"Muito Alto\";\n    alerta_CO2 = \"Cuidado\"\n    cor = \"black\";\n}\nmsg.status_CO2_text = `<div style='color:${cor};font-weight:bold;'>${status_CO2}</div>`;\nmsg.alerta_CO2_text = `<div style='color:${cor};font-weight:bold;'>${alerta_CO2}</div>`;\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":160,"y":900,"wires":[["e4ef974f01b8f774","04d5457cd20c0273"]]},{"id":"e4ef974f01b8f774","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":7,"width":0,"height":0,"name":"Status CO2","label":"Status CO2","format":"{{msg.status_CO2_text}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":470,"y":900,"wires":[]},{"id":"04d5457cd20c0273","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":9,"width":0,"height":0,"name":"Alerta_CO2","label":"Alerta_CO2","format":"{{msg.alerta_CO2_text}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":470,"y":940,"wires":[]},{"id":"90f6e8422a7ab4c5","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":6,"width":0,"height":0,"name":"Irrigação","label":"Irrigação","format":"{{msg.status_irrig_text}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":620,"y":1040,"wires":[]},{"id":"d3ea3423c1b2ed28","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":4,"width":0,"height":0,"name":"status ar","label":"Umidade Ar","format":"{{msg.status_ar_text}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":900,"y":920,"wires":[]},{"id":"56bb4e59697ef962","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":5,"width":0,"height":0,"name":"Umid solo","label":"Umidade Solo","format":"{{msg.status_solo_text}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":620,"y":1000,"wires":[]},{"id":"8941451a78913547","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":3,"width":0,"height":0,"name":"statusÁrea X","label":"Status Área","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":610,"y":1140,"wires":[]},{"id":"e0596c7cca18f35e","type":"ui_text","z":"5e17eab6afbdcf45","group":"dashboard_group","order":2,"width":0,"height":0,"name":"Saúde ÁreaA","label":"Saúde Área A","format":"{{msg.payload}}","layout":"row-spread","className":"","style":false,"font":"","fontSize":"","color":"#000000","x":610,"y":1080,"wires":[]},{"id":"lum_inject_24h","type":"inject","z":"5e17eab6afbdcf45","name":"Atualizar Luminosidade a cada 5min","props":[],"repeat":"300","once":true,"onceDelay":0.1,"topic":"","x":190,"y":2080,"wires":[["lum_http_24h"]]},{"id":"lum_http_24h","type":"http request","z":"5e17eab6afbdcf45","name":"Buscar JSON da Planilha - Luminosidade","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://script.google.com/macros/s/AKfycbyM348FjuVLAGaz2VBjCJMf-L-OJL8RVSc_ln9oIOHvpwBP-jkN4s_1E1iWJZcwIYni7g/exec","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":520,"y":2080,"wires":[["lum_filter_24h"]]},{"id":"lum_filter_24h","type":"function","z":"5e17eab6afbdcf45","name":"Filtrar últimas 24h - Luminosidade","func":"let now = new Date();\nlet cutoff = now.getTime() - 24*60*60*1000; // 24h atrás\n\nlet dados = msg.payload;\nlet filtrado = dados.filter(l => new Date(l.timestamp).getTime() >= cutoff);\n\nmsg.payload = [{\n    series: [\"Luminosidade\"],\n    data: [filtrado.map(l => ({ x: new Date(l.timestamp), y: Number(l.Luminosidade) }))],\n    labels: [\"\"]\n}];\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":2140,"wires":[["lum_chart_24h"]]},{"id":"lum_chart_24h","type":"ui_chart","z":"5e17eab6afbdcf45","name":"Gráfico Luminosidade","group":"e30071bd08154d5d","order":14,"width":0,"height":0,"label":"Luminosidade (24h)","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"Aguardando dados...","dot":false,"ymin":"0","ymax":"100","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#ffcc00","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"outputs":1,"useDifferentColor":false,"className":"","x":970,"y":2120,"wires":[[]]},{"id":"chuva_inject_24h","type":"inject","z":"5e17eab6afbdcf45","name":"Atualizar Chuva a cada 5min","props":[],"repeat":"300","once":true,"onceDelay":0.1,"topic":"","x":150,"y":2160,"wires":[["chuva_http_24h"]]},{"id":"chuva_http_24h","type":"http request","z":"5e17eab6afbdcf45","name":"Buscar JSON da Planilha - Chuva","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://script.google.com/macros/s/AKfycbyM348FjuVLAGaz2VBjCJMf-L-OJL8RVSc_ln9oIOHvpwBP-jkN4s_1E1iWJZcwIYni7g/exec","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":340,"y":2220,"wires":[["chuva_filter_24h"]]},{"id":"chuva_filter_24h","type":"function","z":"5e17eab6afbdcf45","name":"Filtrar últimas 24h - Chuva","func":"let now = new Date();\nlet cutoff = now.getTime() - 24*60*60*1000; // 24h atrás\n\nlet dados = msg.payload;\nlet filtrado = dados.filter(l => new Date(l.timestamp).getTime() >= cutoff);\n\nmsg.payload = [{\n    series: [\"Chuva\"],\n    data: [filtrado.map(l => ({ x: new Date(l.timestamp), y: Number(l.Chuva) }))],\n    labels: [\"\"]\n}];\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":2200,"wires":[["chuva_chart_24h"]]},{"id":"chuva_chart_24h","type":"ui_chart","z":"5e17eab6afbdcf45","name":"Gráfico Chuva","group":"e30071bd08154d5d","order":15,"width":0,"height":0,"label":"Chuva (24h)","chartType":"line","legend":"false","xformat":"HH:mm","interpolate":"linear","nodata":"Aguardando dados...","dot":false,"ymin":"0","ymax":"100","removeOlder":"24","removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"useUTC":false,"colors":["#0044ff","#000000","#000000","#000000","#000000","#000000","#000000","#000000","#000000"],"outputs":1,"useDifferentColor":false,"className":"","x":940,"y":2200,"wires":[[]]},{"id":"830d62efe146b41f","type":"function","z":"5e17eab6afbdcf45","name":"function 1  -29.626038, -53.938216","func":"// Localização fixa - Boca do Monte / Santa Maria - RS\nmsg.payload = {\n    name: \"Estação Boca do Monte\",\n    lat: -29.626038,//-29.69570856509182, \n    lon: -53.938216, //-53.87654296677099,\n    icon: \"cloud\",\n    layer: \"Estação Meteorológica\",\n    popup: \"Estação ativa<br>Telemetria conectada\",\n    ttl: 60\n};\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":2480,"wires":[["e49d170d0e156072"]]},{"id":"e49d170d0e156072","type":"ui_worldmap","z":"5e17eab6afbdcf45","group":"dashboard_group","order":1,"width":"0","height":"0","name":"Localização","lat":"-29.626038","lon":"-53.938216","zoom":"15","layer":"OSMC","cluster":"","maxage":"","usermenu":"hide","layers":"hide","panit":"false","panlock":"false","zoomlock":"false","hiderightclick":"true","coords":"none","showgrid":"false","showruler":"false","allowFileDrop":"false","path":"/worldmap","overlist":"DR,CO,RA,DN,HM","maplist":"OSMG,OSMC,EsriC,EsriS,EsriT,EsriDG,UKOS","mapname":"","mapurl":"","mapopt":"","mapwms":false,"x":790,"y":2560,"wires":[]},{"id":"calc_prob_from_payload","type":"function","z":"5e17eab6afbdcf45","name":"Calcular Prob. (do payload MQTT)","func":"// Recebe msg.payload = { Temperatura: x, Orvalho: y, ... }\nlet p = msg.payload || {};\nlet T = Number(p.Temperatura);\nlet Td = Number(p.Orvalho);\nif (isNaN(T) || isNaN(Td)) {\n    node.warn('Temperatura ou Orvalho ausente em payload');\n    return null;\n}\nlet diff = Math.abs(T - Td);\nlet prob = 0;\nif (diff <= 0.5) prob = 100;\nelse if (diff < 3) prob = Math.round(100 - ((diff - 0.5) / 2.5) * 100);\nelse prob = 0;\nmsg.payload = prob; // valor que vai pro gauge\nmsg.topic = 'prob_chuva';\nmsg.diff = diff;\nmsg.info = `ΔT=${diff.toFixed(2)}°C (T=${T} Td=${Td})`;\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":560,"wires":[["gauge_prob_chuva","text_dt_info","0845754d25044145"]]},{"id":"gauge_prob_chuva","type":"ui_gauge","z":"5e17eab6afbdcf45","name":"Prob. Chuva (%)","group":"f736f70ae8c61a61","order":20,"width":"0","height":"0","gtype":"gage","title":"Prob. Chuva","label":"%","format":"{{msg.payload}}","min":"0","max":"100","colors":["#15b300","#e6e600","#3a4acb"],"seg1":"60","seg2":"85","diff":false,"className":"","x":900,"y":520,"wires":[]},{"id":"text_dt_info","type":"ui_text","z":"5e17eab6afbdcf45","group":"f736f70ae8c61a61","order":21,"width":6,"height":1,"name":"ΔT Info","label":"Diferença T–Td","format":"{{msg.info}}","layout":"row-spread","x":900,"y":580,"wires":[]},{"id":"9d0c82ad1f277388","type":"mqtt-broker","name":"662267b4d75448ff9ab5c5bcb043bd1f","broker":"662267b4d75448ff9ab5c5bcb043bd1f.s1.eu.hivemq.cloud","port":"8883","tls":"","clientid":"662267b4d75448ff9ab5c5bcb043bd1f","autoConnect":true,"usetls":true,"protocolVersion":4,"keepalive":60,"cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"00c7969fe6a51bf6","type":"ui_group","name":"Sensores","tab":"dashboard_tab","order":3,"disp":true,"width":6,"collapse":false,"className":""},{"id":"f736f70ae8c61a61","type":"ui_group","name":"Sensores","tab":"dashboard_tab","order":4,"disp":true,"width":6,"collapse":false,"className":""},{"id":"e30071bd08154d5d","type":"ui_group","name":"Clima","tab":"dashboard_tab","order":2,"disp":true,"width":6,"collapse":false,"className":""},{"id":"dashboard_group","type":"ui_group","name":"Diagnostico da Lavoura","tab":"dashboard_tab","order":1,"disp":true,"width":"6","collapse":false,"className":""},{"id":"dashboard_tab","type":"ui_tab","name":"VisuoAgro Dashboard","icon":"dashboard","order":1,"disabled":false,"hidden":false}]
